# Amazon SP-API レビュー依頼システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Amazon Manager - レビュー依頼自動化システム

### 1.2 目的
Amazon SP-APIを活用して、Amazonでの商品レビュー依頼を効率化・自動化するWebアプリケーションを開発する。注文情報の取得、レビュー依頼対象の自動判定、Amazon Solicitation APIを使った安全なレビュー依頼送信を中心とした機能を提供する。

### 1.3 対象ユーザー
- 開発者（Amazonセラー）本人のみの単一ユーザーアプリケーション
- マルチテナント機能は不要

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 注文情報管理機能（実装済み）
- SP-APIのOrders APIを使用した注文情報の取得
- 注文一覧の表示（日付フィルター機能付き）
- 注文詳細情報の表示
- 注文ステータスの確認
- 大量データの高速表示（段階的表示による体感速度向上）
- ページネーション機能（100件ずつ表示）

#### 2.1.2 データ永続化・キャッシュ機能（実装済み）
- ローカルファイルベースの注文データ永続化（.orders-cache/orders.json）
- 取得済みデータの再利用による高速表示
- 差分更新機能（新規注文の追加、既存注文の更新）
- 期限切れデータの自動クリーンアップ（1ヶ月前より古いデータを削除）
- Solicitationチェック結果の保存・復元

#### 2.1.3 レビュー依頼システム（実装済み）
**A. Solicitation Actions APIによる対象判定**
- Amazon Solicitation Actions APIを使用した送信可能性の事前チェック
- 詳細な対象外理由の分析・表示
  - 送信期限切れ（30日経過）
  - 注文ステータス（キャンセル済み、未発送など）
  - レビュー依頼済み
  - 制限付き商品カテゴリ
  - 買い手による拒否設定
  - Amazonポリシー違反
- チェック結果の永続化（重複チェック回避）

**B. レビュー依頼送信機能**
- Amazon Solicitation APIを使用した公式レビュー依頼送信
- 個別注文への単発送信
- 複数注文への一括送信（バッチ処理）
- レート制限対応（Solicitation API: 1 req/sec）
- 送信結果の記録・管理

**C. 高度なフィルタリング機能**
- 基本条件フィルタ（発送済み、30日以内、未送信、メールアドレス有）
- Amazon API結果フィルタ（実際の送信可能性）
- 日付範囲指定フィルタ

#### 2.1.4 API最適化・パフォーマンス機能（実装済み）
**A. Orders API最適化**
- 自動ページネーション（60秒クールダウン対応）
- 段階的データ表示（基本情報→詳細情報の順次追加）
- 強制リフレッシュ機能

**B. Solicitation API最適化**
- 1秒間隔での順次処理（レート制限対応）
- クールダウン期間の有効活用
- 重複チェック回避（既にチェック済みの注文はスキップ）
- バッチ処理での効率化

**C. レート制限対応**
- Exponential backoff with jitterによるリトライ処理
- レート制限統計の記録・表示
- 429エラーの適切なハンドリング

### 2.2 非機能要件

#### 2.2.1 技術要件（実装済み）
- フロントエンド: Next.js 15（App Router）, React 19
- バックエンド: Next.js API Routes
- データ管理: ローカルファイルベース永続化（.orders-cache/）
- プログラミング言語: TypeScript
- SP-API連携: 直接API連携（LWAトークンベース認証）
- スタイリング: Tailwind CSS, Radix UI

#### 2.2.2 パフォーマンス要件（実装済み）
- 初回データ表示: 2秒以内（段階的表示）
- キャッシュからの表示: 1秒以内
- API呼び出し時のレスポンス時間: 5秒以内
- 大量データ（1000件以上）の効率的処理
- ページネーション（100件/ページ）

#### 2.2.3 セキュリティ要件（実装済み）
- SP-API認証情報の環境変数管理
- LWAトークンの自動更新・管理
- プロキシ設定対応（統一プロキシ設定）
- HTTPS通信の必須化

#### 2.2.4 データ管理要件（実装済み）
- ローカルファイルによる永続化（.orders-cache/orders.json）
- データの24時間有効期限管理
- 自動データクリーンアップ（1ヶ月前より古いデータ削除）
- 差分更新による効率的なデータ管理
- Solicitationチェック結果の保存・復元

## 3. Amazon SP-API 仕様（実装済み）

### 3.1 認証方式（実装済み）
- LWA（Login with Amazon）トークンベース認証
- リフレッシュトークンによる自動アクセストークン更新
- トークン有効期限管理（1分のマージン付き）
- 環境変数による認証情報管理

### 3.2 使用API（実装済み）

#### 3.2.1 Orders API（実装済み）
- エンドポイント: `/orders/v0/orders`
- 用途: 注文情報の取得、ページネーション
- レート制限: 60秒クールダウン（ページネーション時）
- パラメータ: MarketplaceIds, CreatedAfter, CreatedBefore, OrderStatuses, MaxResultsPerPage, NextToken

#### 3.2.2 Solicitation Actions API（実装済み）
- エンドポイント: `/solicitations/v1/orders/{orderId}`
- 用途: レビュー依頼送信可能性の事前チェック
- レート制限: 1 req/sec
- 詳細理由分析機能付き

#### 3.2.3 Solicitation API（実装済み）
- エンドポイント: `/solicitations/v1/orders/{orderId}/solicitations/productReviewAndSellerFeedback`
- 用途: 公式レビュー依頼の送信
- レート制限: 1 req/sec
- 送信結果の記録・管理

### 3.3 API呼び出しフロー（実装済み）
1. 環境変数からの認証情報読み込み
2. リフレッシュトークンを使用したアクセストークン自動取得
3. レート制限対応付きAPI呼び出し実行
4. エラーハンドリング（429エラー時の自動リトライ）
5. 結果のローカル永続化

## 4. システム構成（実装済み）

### 4.1 技術スタック（実装済み）
- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **データ管理**: ローカルファイルベース永続化（データベース不使用）
- **スタイリング**: Tailwind CSS, Radix UI
- **SP-API連携**: 直接API連携（自作実装）
- **デプロイ**: Vercel対応

### 4.2 アーキテクチャ（実装済み）
- サーバーサイドレンダリング（SSR）とクライアントサイドレンダリング（CSR）のハイブリッド
- API Routesを使用したバックエンド処理
- ローカルファイルベース永続化による高速データアクセス
- Amazon SP-APIとの直接連携
- レート制限対応・エラーハンドリング

### 4.3 主要コンポーネント（実装済み）
- **AmazonApiService**: SP-API連携、認証、レート制限対応
- **OrdersStorage**: 注文データの永続化・キャッシュ管理
- **ReviewService**: レビュー依頼機能、Solicitation API連携
- **useOrders**: 注文データのフック、ページネーション
- **useReviewRequests**: レビュー依頼のフック
- **useEligibilityCheck**: 送信可能性チェックのフック

## 5. データ設計（実装済み）

### 5.1 主要データエンティティ（実装済み）
**注文情報（Order）**
- id, amazonOrderId, purchaseDate, orderStatus
- fulfillmentChannel, salesChannel, totalAmount, currency
- numberOfItemsShipped, numberOfItemsUnshipped
- customer（name, email, buyerInfo）
- items（商品情報配列）
- shippingAddress
- reviewRequestSent, reviewRequestStatus
- solicitationEligible, solicitationReason

**レビュー依頼（ReviewRequest）**
- orderId, customerEmail, customerName, items
- requestedAt, status, message

**バッチレビュー依頼（ReviewRequestBatch）**
- id, orders, requestedAt, totalCount
- sentCount, failedCount, status

### 5.2 データ管理方針（実装済み）
- SP-APIから取得したデータはローカルファイルに永続化
- .orders-cache/orders.json での注文データ保存
- 差分更新による効率的なデータ管理
- 期限切れデータの自動削除（1ヶ月前より古いデータ）
- Solicitationチェック結果の保存・復元

## 6. 開発・運用要件（実装済み）

### 6.1 開発環境（実装済み）
- Node.js 18+
- npm（package.json設定済み）
- Git バージョン管理
- Next.js 15開発環境

### 6.2 品質管理（実装済み）
- TypeScript型安全性の確保
- ESLint + Next.js標準設定によるコード品質管理
- 関心の分離アーキテクチャ（UI/ロジック分離）
- エラーハンドリングの充実

### 6.3 運用要件（実装済み）
- 開発者単体での運用
- 詳細なログ出力・デバッグ機能
- 包括的エラーハンドリング（API、認証、レート制限）
- レート制限統計の記録・表示

### 6.4 環境設定（実装済み）
- 統一プロキシ設定対応
- 環境変数による設定管理
- デバッグモード対応

## 7. 実装完了機能

### 7.1 基盤機能（完了）
- ✅ Next.js 15プロジェクトセットアップ
- ✅ SP-API認証・トークン管理
- ✅ ローカルファイルベース永続化
- ✅ レート制限対応・エラーハンドリング

### 7.2 注文管理機能（完了）
- ✅ Orders API連携・ページネーション
- ✅ 注文一覧・詳細表示
- ✅ 日付フィルター機能
- ✅ 段階的データ表示による高速化

### 7.3 レビュー依頼機能（完了）
- ✅ Solicitation Actions APIによる事前チェック
- ✅ 詳細な対象外理由分析
- ✅ Solicitation APIによる公式送信
- ✅ 個別・バッチ送信機能
- ✅ 送信結果の記録・管理

### 7.4 パフォーマンス最適化（完了）
- ✅ API最適化（クールダウン期間の有効活用）
- ✅ 重複処理回避（Solicitationチェック結果保存）
- ✅ 差分更新によるデータ管理効率化
- ✅ UI/UX改善（段階的表示、ページネーション）

## 8. 今後の拡張可能性

### 8.1 機能拡張案
- データエクスポート機能の追加
- レビュー依頼テンプレートのカスタマイズ
- 統計・分析機能の追加
- 自動化スケジュール機能

### 8.2 技術的改善案
- よりの詳細な商品情報取得（Catalog Items API）
- 在庫情報との連携（Inventory API）
- Webhookによるリアルタイム更新
- クラウドデータベースへの移行（オプション）

## 9. 実装成果物

### 9.1 システム成果物（完了）
- ✅ レビュー依頼自動化Webアプリケーション
- ✅ Amazon SP-API完全連携システム
- ✅ ローカルファイルベース永続化システム
- ✅ 高度なレート制限対応システム

### 9.2 ドキュメント成果物（完了）
- ✅ 要件定義書（本書）
- ✅ CLAUDE.md（開発ガイドライン）
- ✅ SP-API設定手順書
- ✅ 包括的なコードコメント・ログ出力

## 10. システムの特徴と優位性

### 10.1 技術的特徴
- **高度なAPI最適化**: Orders API 60秒制限とSolicitation API 1秒制限への完全対応
- **インテリジェント処理**: クールダウン期間の有効活用による効率化
- **堅牢性**: 包括的エラーハンドリングとリトライ機能
- **パフォーマンス**: 段階的表示による体感速度の大幅向上

### 10.2 業務的優位性
- **Amazonポリシー完全準拠**: 公式Solicitation APIのみ使用
- **詳細な対象外理由分析**: なぜ送信できないかを明確に表示
- **重複処理回避**: 一度チェックした注文は結果を保存・再利用
- **効率的運用**: 基本条件+Amazon APIの二段階フィルタリング